<!DOCTYPE html>
<html>
<head>
    <title>Milestone Burnup with Projection</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                function storeDataToString(e,t){if(!e||!e[0]||!e[0].raw)return"No data to display: "+e;var r=t||Object.keys(e[0].raw),n=r.map(function(e){return e.split(".")});return e.reduce(function(e,t){return e.push(n.map(function(e){var r=t.raw[e[0]];return""+r=="[object Object]"&&e[1]?r[e[1]]:r}).join("\t")),e},[r.join("\t")+"\t"+e.length]).join("\n")}function resolvedPromise(e){return Deft.promise.Promise.when(e)}function rejectedPromise(e){var t=Ext.create("Deft.Deferred");return t.reject(e),t.promise}function promiseAll(e){return 0===e.length?[]:Deft.Promise.all(e)}function collectIds(e){return e.map(function(e){return+e.raw.ObjectID})}function getRallyRecordType(e){return e&&e.getData()._type}function getRallyIdFromRef(e,t){return+e.slice(t.length+2)}function milestoneIcon(e){return"<span class='artifact-icon icon-milestone' style='transform:rotate(20deg);color: "+e.get("DisplayColor")+";'></span>"}function formatMilestone(e,t){return milestoneIcon(e)+"<a target='_blank' style='color:#274b6d' href='"+getMilestoneUrl(e,t)+"'>"+e.get("Name")+"</a>"}function getMilestoneUrl(e,t){return"https://rally1.rallydev.com/#/"+t.getProject().ObjectID+"d/detail"+e.getUri()}function formatProject(e,t){return t?"<a target='_blank' style='color:#274b6d' href='https://rally1.rallydev.com/#/"+e.get("ObjectID")+"d/"+t+"'>"+e.get("Name")+"</a>":e.get("Name")}function formatPortfolioItem(e,t){return"<a target='_blank' style='color:#274b6d' href='"+getPortfolioItemUrl(e,t)+"'><strong style='font-size:0.95em'>"+e.get("FormattedID")+"</strong> "+e.get("Name")+"</a>"}function getPortfolioItemUrl(e,t){return"https://rally1.rallydev.com/#/"+t.getProject().ObjectID+"d/detail"+e.getUri()}function hasOwnProperties(e,t){for(var r in t=t||1,e)if(e.hasOwnProperty(r)&&!--t)return!0;return!1}function loggingSnapshotStoreExceptionHandler(e,t,r){var n=JSON.parse(t.responseText),o=function(e){console.log(e)};console.log("Problem when obtaining snapshot data:"),n.Errors.forEach(o),n.Warnings.forEach(o),console.log("proxy:",e,"response:",t,"operation:",r)}function formatDate(e){return Rally.util.DateTime.format(e instanceof Date?e:new Date(e),"dMy")}function dateToIsoString(e){return e.toISOString().substring(0,10)}function chainedExpression(e,t){return"(("+t.filter(function(e){return!!e}).join(") "+e+" (")+"))"}function workItemQuery(e,t){var r=e.filter(function(e){return"9999-01-01T00:00:00.000Z"===e.data._ValidTo}).filter(t).map(function(e){return"ObjectID = "+e.data.ObjectID});return r.length>0?chainedExpression("OR",r):"* no such items *"}function isUserStory(e){return 0===e.data.FormattedID.indexOf("US")}function isDefect(e){return 0===e.data.FormattedID.indexOf("DE")}function isAccepted(e){return"Accepted"===e.data.ScheduleState||"Released-to-Production"===e.data.ScheduleState}function addBusinessDays(e,t){var r=new Date(e);if(t){for(var n=r.getTimezoneOffset(),o=r.getDate(),a=r.getDay(),i=t>0?1:-1,u=t>0?1:6;0!==t;)o+=i,0!==(a=(a+u)%7)&&6!==a&&(t-=i);r.setDate(o);var s=r.getTimezoneOffset()-n;0!==s&&r.setTime(r.getTime()-6e4*s)}return r}function lastBusinessDay(e){var t=new Date(e).getDay();return t>0&&t<6?e:lastBusinessDay(addBusinessDays(e,-1))}function parseCapacityPlan(e){if(!e)return null;var t=e.toString().trim();if(!t)return null;for(var r,n=("1970-01-01 "+t).split(/\s+/),o=new Date(-1),a={dates:[],values:[]},i=0,u=1;u<n.length;i+=2,u+=2){if(r=new Date(n[i]),!n[i].match(/^\d\d\d\d-\d\d?-\d\d?$/)||isNaN(r.getTime()))throw"'"+n[i]+"' found when a date was expected. The expected format is YYYY-MM-DD";if(o>=r)throw"Invalid date: '"+dateToIsoString(r)+"'. It must be greater than '"+dateToIsoString(o)+"'";o=r;var s=parseFloat(n[u]);if(!n[u].match(/^[+\-]?(\d*(\.\d+)|\d+)$/)||isNaN(s))throw"'"+n[u]+"' found when a capacity value was expected. It must be a number";if(s<0)throw"'"+n[u]+"' found when a capacity value was expected. It must be a positive number";a.dates.push(dateToIsoString(r)),a.values.push(s)}if(u===n.length)throw"Unexpected value at the end: '"+n[i]+"'. Capacity Plan definition must end with a capacity value preceeded by a date";return a.dates.push(dateToIsoString(new Date(9999999999999))),a}function createLogger(e,t,r,n,o){return function(a,i,u){var s="***** DEBUG INFO for MILESTONE BURNUP "+e.map(function(e){return"<> "+e.get("Name")}).join(", ");t&&(s+=": "+t.map(function(e){return e.get("FormattedID")}).join(", ")),r.length>0&&(s+=" ["+r.join("][")+"]"),s+=" - "+n.get("Name")+" ***** ";var c=function(e,t){console.debug(s+e+":"),console.debug(t),console.debug()};c("DATA SNAPSHOTS",storeDataToString(i,o)),c("Query for ALL STORIES",workItemQuery(i,function(e){return isUserStory(e)})),c("Query for ALL DEFECTS",workItemQuery(i,function(e){return isDefect(e)})),c("Query for NOT YET ACCEPTED STORIES",workItemQuery(i,function(e){return isUserStory(e)&&!isAccepted(e)})),c("Query for NOT YET ACCEPTED DEFECTS",workItemQuery(i,function(e){return isDefect(e)&&!isAccepted(e)}))}}function filterOutUnwantedPortfolioItems(e,t){return t.filter(function(t){return-1!==e.indexOf(t.get("FormattedID"))})}
                Ext.define("My.BurnUpCalculation",{calculate:function(t,e){this.calcConfig={today:e.today||new Date,maxEndDate:e.maxEndDate,iteration:e.iteration,capacityPlan:e.capacityPlan,auxDates:e.auxDates,drawIterations:e.drawIterations,targetDate:e.targetDate,customStartDate:e.customStartDate,maxDaysAfterTargetDate:e.maxDaysAfterTargetDate,customTrendStartDate:e.customTrendStartDate,displayWidth:e.displayWidth};var a={Scope:{position:0},"Not Started":{position:1},"In Progress":{position:2},Completed:{position:3},Accepted:{position:4}},i={capacity:function(t){return this.projectionCalculator.capacityPlan?this.projectionCalculator.stepWeight(t):null},idealBurnUp:function(t){return this.idealSeries&&this.idealSeries[t-1]&&this.idealSeries[t]?this.idealSeries[t]-this.idealSeries[t-1]:null}};return this.capacityProvider=i,this.chartConfig={xAxis:{plotLines:[]},yAxis:{},subtitle:{useHTML:!0},tooltip:{formatter:function(){var t={categories:[],get:function(e){return t.categories[a[e].position]},set:function(e,i){t.categories[a[e].position]=i}};this.points.forEach(function(e){t.set(e.series.name,{value:e.y,name:e.series.name,color:e.series.color})}),t.get("Scope")&&t.get("In Progress")&&t.get("Completed")&&t.get("Accepted")&&t.set("Not Started",{value:t.get("Scope").value-t.get("In Progress").value-t.get("Completed").value-t.get("Accepted").value,name:"Not Started",color:"#CFCFCF"}),t.categories.forEach(function(e){if(e.valueWholePart=Math.floor(e.value),e.valueDecimalPart=Math.floor(Math.round(10*(e.value-e.valueWholePart))),e.valueDecimalPart&&(t.isValueDecimalPart=!0),t.get("Scope")){var a=Math.round(e.value/t.get("Scope").value*1e3),i=Math.floor(a/10);e.percent=i+"."+Math.floor(Math.round(a-10*i))+"%"}});var e="<table style='border-spacing: 1ex 0; width: 100%'><caption style='padding-bottom: 0.4em'>"+this.x+"</caption>";t.categories.forEach(function(a){if(a.value>0){var i=a.valueWholePart+(t.isValueDecimalPart?"."+a.valueDecimalPart:"");e+="<tr><td style='color:"+a.color+"'>"+a.name+":</td><td style='font-weight: bold; text-align: right'>"+i+"</td>"+(a.percent?"<td style='text-align: right'>"+a.percent+"</td>":"")+"</tr>"}}),e+="</table>";var r=[],n=this.points[0].point.x,s=i.capacity(n);null!==s&&r.push("Planned capacity: "+s);var o=i.idealBurnUp(n);return null!==o&&r.push("Ideal burnup: <b>"+o.toFixed(2)+"</b>"),r&&(e+="<div style='padding-top: 0.8em; text-align: center; font-size: 0.9em'>"+r.join("<br/>")+"</div>"),e},useHTML:!0,shared:!0}},this.adjustChartStart(t),this.stripFutureBars(t),this.addTrendLinesAndSubtitle(t),this.adjustDataAndChartConfig(t),this.chartConfig},adjustChartStart:function(t){var e=this.findDateIndex(t.categories,lastBusinessDay(this.calcConfig.today),!1,t.categories.length);t.series.forEach(function(t){if("Scope"!==t.name)for(var a=0;a<t.data.length;a++)if(t.data[a]>0&&a<e){e=a;break}});var a=this.calcConfig.customStartDate?this.findDateIndex(t.categories,this.calcConfig.customStartDate,!1,0):e;t.series.forEach(function(t){t.data=t.data.slice(a)}),t.categories=t.categories.slice(a)},stripFutureBars:function(t){var e=this.findDateIndex(t.categories,this.calcConfig.today,!1,t.categories.length)+1;t.series.forEach(function(t){if("Scope"!==t.name)for(var a=e;a<t.data.length;a++)t.data[a]=null})},addVerticalLine:function(t,e,a){if(-1!==e){for(var i=this.chartConfig.xAxis.plotLines,r=0;r<i.length;r++)i[r].value===e&&(t=i[r].label.text+" / "+t,i.splice(r,1));i.push(Ext.merge({label:{text:t,y:3,x:3,useHTML:!0},value:e,width:2,color:"#000",zIndex:5},a))}},addSeriesLine:function(t,e,a,i){a&&t.series.push(Ext.merge({name:e,data:a,type:"line",marker:{enabled:!1},enableMouseTracking:!1,lineWidth:1},i))},addSubtitleText:function(t){var e=this.chartConfig.subtitle;e.text=e.text?e.text+" &nbsp;&nbsp;&nbsp; "+t:t},addTrendLinesAndSubtitle:function(t){var e,a,i=this.calcConfig,r=this.getSeriesData(t,"Accepted"),n=this.getSeriesData(t,"Scope"),s=t.categories,o=this.findDateIndex(s,i.today),c=this.findDateIndex(s,this.calcConfig.targetDate),l=r[o],d=n[o],h=this.getTrendStart(s,r),u=this.createProjectionCalculator({capacityPlan:this.calcConfig.capacityPlan,projectionStart:h,firstDate:s[0]});if(this.capacityProvider.projectionCalculator=u,this.calcConfig.targetDate){var f=u.projectionSeries(c,n[c],c);this.capacityProvider.idealSeries=f,this.addSeriesLine(t,"Ideal",f,{dashStyle:"Dot"}),this.addSubtitleText("Target Date: "+formatDate(this.calcConfig.targetDate))}var p,g,x,D=o;if(l===d&&d>0){for(var v=D-1;r[v]===d||null===r[v]&&n[v]===d;)D--,v--;a=D}else{var y=s.length-1,S=n[y];if(r[y]===S&&S>0){a=y;for(var m=y-1;r[m]===S||null===r[m]&&n[m]===S;)a--,m--}}if(-1!==D){var C=this.calcConfig.maxDaysAfterTargetDate||0;g=Math.max(o,(-1===c?D:c)+C),u.projectionFactor(D,l,1/0,d)!==1/0&&(e=u.projectionSeries(D,l,1/0,d))&&(this.addSeriesLine(t,"Trend",e.slice(0,g+1),{dashStyle:"Dash"}),p=e.length-1,this.projectedEndDate=addBusinessDays(new Date(s[0]),p),!a&&this.projectedEndDate&&this.addSubtitleText("Projected Date: "+formatDate(this.projectedEndDate)));for(var P=Math.max(o,c,s.length-1);P<g;P++)n.push(d),s.push(dateToIsoString(addBusinessDays(new Date(s[s.length-1]),1)))}var I=s.length;if(a)x=Math.max(a,c)+1,s.splice(x,I),r.splice(x,I),n.splice(x,I),this.getSeriesData(t,"In Progress").splice(x,I),this.getSeriesData(t,"Completed").splice(x,I),this.addSubtitleText("Accepted: "+formatDate(s[a]));else{var j=function(t,e){return-1===t||null===t||void 0===t?e:t};(x=Math.max(j(o,0),j(c,0),Math.min(j(p,null),j(g,null)))+1)&&(s.splice(x,I),n.splice(x,I))}this.addPlotLines(s,p,a);var b=1.3*d;n.reduce(function(t,e){return t>e?t:e},0)>b&&(this.chartConfig.yAxis.max=b),i.drawIterations&&this.addIterationsBands(s)},addPlotLines:function(t,e,a){var i=this.calcConfig;if(i.auxDates&&hasOwnProperties(i.auxDates,1))for(var r in i.auxDates)i.auxDates.hasOwnProperty(r)&&this.addVerticalLine(i.auxDates[r],this.findDateIndex(t,r,!0),{width:1,label:{x:2}});this.addVerticalLine("Today",this.findDateIndex(t,i.today,!0),{color:"#AAA",dashStyle:"ShortDash"}),this.addVerticalLine("Target Date",this.findDateIndex(t,i.targetDate,!0)),a?this.addVerticalLine("Accepted",a,{color:"#774"}):e&&this.addVerticalLine("Projected Date",e,{dashStyle:"ShortDash"})},addIterationsBands:function(t){for(var e=this.calcConfig,a=e.iteration.get("StartDate"),i=e.iteration.get("EndDate"),r=0,n=a;n<i;)n=addBusinessDays(n,1),r++;for(var s=!0,o=a;dateToIsoString(o)>t[0];)o=addBusinessDays(o,-r),s=!s;do{o=addBusinessDays(o,r),s=!s}while(dateToIsoString(o)<t[0]);var c=this.findDateIndex(t,o);if(-1!==c){this.chartConfig.xAxis.plotBands=[];var l=c-(s?r:0);do{this.chartConfig.xAxis.plotBands.push({color:"#F8F9FD",from:Math.max(0,l),to:l+r}),l+=2*r}while(l<t.length)}},getTrendStart:function(t,e){var a;if(this.calcConfig.customTrendStartDate)a=this.findDateIndex(t,this.calcConfig.customTrendStartDate,!1,0);else for(a=0;a<e.length&&!(e[a]>0);a++);return{index:a,value:e[a]||0}},findDateIndex:function(t,e,a,i){var r=e instanceof Date?dateToIsoString(e):e;if(t.length>0&&t[0]<=r)for(var n=0;n<t.length;n++){var s=t[n];if(s>=r)return s>r?n-(a?.5:1):n}return i||0===i?i:-1},getSeriesData:function(t,e){for(var a=0;a<t.series.length;a++){var i=t.series[a];if(i.name===e)return i.data}return[]},adjustDataAndChartConfig:function(t){t.categories=t.categories.map(function(t){return formatDate(t)});var e,a,i,r,n=Math.max(Math.min(+this.calcConfig.displayWidth||100,500),10),s=t.categories.length*(100/n);s>360?(i=0,a=3,e=30):s>240?(i=.05,a=3,e=20):s>120?(i=.1,a=3,e=10):(i=.15,r=!0,a=3,e=5),Ext.merge(this.chartConfig,{xAxis:{labels:{step:e}},plotOptions:{line:{marker:{enabled:r},lineWidth:a},column:{groupPadding:i}}})},createProjectionCalculator:function(t){return t.capacityPlan?Ext.create("My.FlexProjectionCalculator",t):Ext.create("My.FixedProjectionCalculator",t)}}),Ext.define("My.FixedProjectionCalculator",{constructor:function(t){this.callParent(arguments),this.startIndex=t.projectionStart.index,this.startValue=t.projectionStart.value},projectionFactor:function(t,e){return this.startIndex>=0&&this.startIndex<t&&this.startValue!==e?this._projectionFactor(t,e):(console.log("Unable to calculate trend step for values: (startIndex="+this.startIndex+", startValue="+this.startValue+", endIndex="+t+", endValue="+e+")"),null)},projectionSeries:function(t,e,a,i){var r=this.projectionFactor(t,e);if(r&&r>0&&0!==a){var n,s=[];for(n=0;n<this.startIndex;n++)s[n]=null;s[n]=this.startValue,n++;for(var o=a||1/0;n<=o&&(!i||s[n-1]+1e-9<i);n++)s[n]=s[n-1]+r*this.stepWeight(n);return s}return null},stepWeight:function(t){return 1},_projectionFactor:function(t,e){return(e-this.startValue)/(t-this.startIndex)}}),Ext.define("My.FlexProjectionCalculator",{extend:"My.FixedProjectionCalculator",constructor:function(t){this.callParent(arguments),this.capacity=[],this.capacityPlan=t.capacityPlan,this.capacityPlanCursor=0,this.dateCursor=t.firstDate},stepWeight:function(t){if(this.capacity[t])return this.capacity[t];for(var e=this.capacity.length;e<=t;e++)this.dateCursor>=this.capacityPlan.dates[this.capacityPlanCursor+1]&&this.capacityPlanCursor++,this.capacity[e]=this.capacityPlan.values[this.capacityPlanCursor],this.dateCursor=dateToIsoString(addBusinessDays(this.dateCursor,1));return this.capacity[t]},_projectionFactor:function(t,e){for(var a=0,i=this.startIndex+1;i<=t;i++)a+=this.stepWeight(i);return(e-this.startValue)/a}});
                window.dev=window.dev||void 0,Ext.define("MilestoneBurnupWithProjection",Ext.merge({extend:"Rally.app.App",componentCls:"app",setContextTimebox:function(t){this._timeboxFromScope=t&&t.getRecord()},getContextTimebox:function(){return this._timeboxFromScope||this.setContextTimebox(this.getContext().getTimeboxScope()),this._timeboxFromScope},getSettingsFields:function(){var t=this.getSetting("milestones"),e={width:400,labelWidth:210,labelAlign:"right"},a=Ext.merge(Ext.clone(e),{format:"Y-m-d"}),i={labelWidth:380},o=(this.getContextTimebox(),[]);return o.push({name:"milestones",label:"<abbr title='What do the chart bars and the Scope line mean?\n\nChart displays historical estimation (Plan Est) of stories and defects assigned to the specified milestone, aggregated by Schedule State.\nScope is the total estimate. Only leaf stories&apos; estimates count. Milestone assigned to a parent story or portfolio item is implicitly\npropagated to the child items. Items that were assigned to the milestone in the past but no longer are, are not considered in the chart at all.'>Milestone(s)</abbr>",xtype:"rallymilestonecombobox",editable:!0,multiSelect:!0,allowNoEntry:!0,emptyText:"-- Choose --",hideLabel:!1,autoSelect:!1,forceSelection:"string"!=typeof t||t.indexOf(",")<0}),o.push({html:"<h3>Additional options</h3>",xtype:"label"}),o.push({name:"project",label:"Project",xtype:"rallyprojectcombobox",allowBlank:!0,allowClear:!0,clearText:"-- Current Project --",emptyText:"-- Current Project --",listeners:{ready:function(t){var e=t.validator;t.validator=function(t){return"-- Current Project --"==t&&(t="",this.setValue(t)),!t||e.call(this,t)}}},config:e}),o.push({name:"teamFeatures",xtype:"textfield",label:"<abbr title='One or more IDs of Portfolio Items, of which story or defect\nmust be a direct or indirect child, for example:\n\nTF12345, FEA1234, PRJ123, PGM12\n\nFor a Team Feature, you can omit the letter prefix (TF).'>Portfolio Items</abbr>:",config:e}),o.push({name:"tags",xtype:"textfield",label:"<abbr title='Comma separated list of tags. At least one must match. Tags are inherited from parents, like milestones.\n\nInstead of assigning tags to the items in a normal way, you can use naming convention - include\nkeywords in square brackets in the item&apos;s name, for example: \"[integration] As a user, I...\".'>Tags</abbr>:",config:e}),o.push({name:"customStartDate",xtype:"rallydatefield",label:"Ignore data until:",config:a}),o.push({name:"customTrendStartDate",xtype:"rallydatefield",label:"Start projection lines from:",config:a}),o.push({name:"maxDaysAfterTargetDate",xtype:"rallynumberfield",label:"Max days to show after Target Date",config:Ext.merge(Ext.clone(e),{minValue:0,maxValue:250})}),o.push({name:"capacityPlan",xtype:"textarea",label:"Model projection lines with a specific capacity plan (provide average daily capacity values separated by the dates when they change &ndash; <abbr title='When the team capacity is 3 before September, in September 6 and 2.5 later:\n\n3 2018-09-01 6 2018-10-01 2.5'>example</abbr>)",height:70,config:e}),o.push({name:"projectTargetPage",xtype:"textfield",label:"When clicking on a project name, open this page:",config:e}),o.push({name:"markAuxDates",xtype:"rallycheckboxfield",label:"Mark additional key dates on the chart (such dates must be specified in the Milestone's Notes field &ndash; <abbr title='When the Code Complete is on Dec 10 and RC Build is planned on Jan 15:\n\n2018-12-10 Code Complete&#013;2019-01-15 RC Build'>example</abbr>)",config:i}),o.push({name:"drawIterations",xtype:"rallycheckboxfield",label:"Draw iteration boundaries on chart's background",config:i}),o.push({name:"displayProjectName",xtype:"rallycheckboxfield",label:"Display project name",config:i}),o.push({name:"displayWidth",xtype:"combobox",label:"Display width %, decrease it to fix chart look in a small display area",store:Ext.create("Ext.data.Store",{fields:["value"],data:[{value:100},{value:50},{value:30}]}),queryMode:"local",displayField:"value",valueField:"value",config:e,validator:function(t){if(isNaN(t))return"Number expected";return!(t<20||t>200)||"Value out of allowed range (20-200)"}}),o.push({name:"debug",xtype:"rallycheckboxfield",label:"Debug mode (prints <abbr title='Use queries that are printed to the console together with the Custom List app (paste them into the Query settings field)\nto identify which actual items (stories and defects) contribute to the chart. Note that such list is not dynamic\nand it contains only the items matching the chart criteria from the moment it was generated.'>diagnostic information</abbr> in JavaScript console)",config:i}),o},config:{defaultSettings:{maxDaysAfterTargetDate:45,markAuxDates:!0,projectTargetPage:"iterationstatus",displayWidth:100,drawIterations:!0,displayProjectName:!0}},getMilestoneIds:function(){if("milestone"===getRallyRecordType(this.getContextTimebox()))return[this.getContextTimebox()];var t=this.getSetting("milestones");return t?t.split(","):[]},getProjectId:function(){var t=this.getSetting("project");return t?getRallyIdFromRef(t,"project"):this.getContext().getProject().ObjectID},getPortfolioItemIds:function(){var t=this.getSetting("teamFeatures");return t?t.toString().split(/\s*[,;\s]\s*/).filter(function(t){return""!==t}).map(function(t){return t.match(/^\d+$/)?"TF"+t:t.toUpperCase()}):[]},getTags:function(){var t=this.getSetting("tags");return t?t.toString().split(/\s*[,;]\s*/).filter(function(t){return""!==t}):[]},setDataLoading:function(t){this.setLoading(!this.dataLoaded&&t)},setDataLoaded:function(t){this.dataLoaded=t,this.setLoading(!1)},layout:"fit",launch:function(){this.getDataForChart().then({success:function(t){this.add(Ext.merge(this.createChart(),t))},failure:function(t){this.setDataLoaded();var e=["Unable to fetch data."];t&&t.error&&t.error.errors?e=e.concat(t.error.errors):e.push(t),this.add({itemId:"chart",xtype:"container",html:e.join("<br/>"),componentCls:"center"})},scope:this})},onTimeboxScopeChange:function(t){var e=t.getRecord();if("milestone"===getRallyRecordType(e)){this.setContextTimebox(t);var a={milestones:[e.get("_ref")]};Rally.data.PreferenceManager.update({appID:this.getAppId(),settings:a}),this.remove("chart"),this.setDataLoaded(!1),this.launch()}},listeners:{boxready:function(t){t.setDataLoading(!0)},ready:function(t){t.defineCalculator()}},defineCalculator:function(){function t(t,e){return{as:t,f:"filteredSum",field:"PlanEstimate",filterField:"ScheduleState",filterValues:e,display:"column"}}Ext.define("My.MilestoneBurnUpCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",mixins:["My.BurnUpCalculation"],getMetrics:function(){return[t("In Progress",["In-Progress"]),t("Completed",["Completed"]),t("Accepted",["Accepted","Released-to-Production"]),{as:"Scope",f:"sum",field:"PlanEstimate",display:"line"}]},runCalculation:function(t,e){var a=this.callParent(arguments);return this.chartConfig=this.calculate(a,this.calculationConfig),a}})},createChart:function(){var t=this;return Ext.create("Rally.ui.chart.Chart",{itemId:"chart",chartColors:["#B4F4D9","#9FDDA7","#6DBD44",t.scopeColor,"#000","#000"],chartConfig:{title:{text:"Milestone"},chart:{zoomType:"xy"},xAxis:{title:{text:"Date"},labels:{maxStaggerLines:1,step:5}},yAxis:{title:{text:"Points"},minRange:10,min:0},plotOptions:{line:{marker:{enabled:!1},lineWidth:4},column:{pointPadding:0,stacking:!0},area:{stacking:!0,marker:{enabled:!1}}}},listeners:{snapshotsAggregated:function(t){Ext.merge(t.chartConfig,t.calculator.chartConfig)},storesLoaded:function(){t.setLoading(!1)}}})},getDataForChart:function(){var t=this.getPortfolioItemIds(),e=this.getTags();return promiseAll([this.getProjectId()?Rally.data.ModelFactory.getModel({type:"Project"}).then({success:function(t){return t.load(this.getProjectId())},scope:this}):this.getProjectId(),Ext.create("Rally.data.wsapi.Store",{model:"Iteration",fetch:["StartDate","EndDate"],filters:Rally.data.wsapi.Filter.fromQueryString("((StartDate <= today) AND (EndDate >= today))")}).load(),0===this.getMilestoneIds().length?[]:Rally.data.ModelFactory.getModel({type:"Milestone"}).then({success:function(t){return promiseAll(this.getMilestoneIds().map(function(e){return t.load(e)}))},scope:this}),0===t.length?[]:Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem",filters:Rally.data.wsapi.Filter.fromQueryString(chainedExpression("OR",t.map(function(t){return"FormattedID = "+t}))),scope:this,context:{projectScopeUp:!0}}).load()]).then({success:function(a){try{this.capacityPlan=parseCapacityPlan(this.getSetting("capacityPlan"))}catch(t){return rejectedPromise("The following problem found in the Capacity Plan definition: <strong>"+t+"</strong>. Please correct the app settings:<pre>"+this.getSetting("capacityPlan")+"</pre>")}this.project=a[0],this.iteration=a[1][0];var i=a[2];if(this.ensureColorsForMilestones(i),0===i.length)return rejectedPromise("No milestone specified. Set milestone filter in your page settings or choose milestone in the app settings.");if(this.portfolioItems=filterOutUnwantedPortfolioItems(this.getPortfolioItemIds(),a[3]),0===this.portfolioItems.length&&t.length>0)return rejectedPromise("None of the Portfolio Items specified in the app settings: <strong>"+t.join(", ")+"</strong>, exist in this project. Please correct the app settings or change the project.");var o=this.loadParentItems(chainedExpression("OR",i.map(function(t){return"Milestones.ObjectID = "+t.getId()}))),n=0===e.length?[]:this.loadParentItems(chainedExpression("OR",e.map(function(t){return'(Tags.Name = "'+t+'") OR (Name contains "['+t+']")'})));return promiseAll([o,n]).then({success:function(t){var a=collectIds([].concat.apply([],t[0])),o=collectIds([].concat.apply([],t[1]));return this.getConfigForChart(a,i,o,e,this.portfolioItems,this.project)},scope:this})},scope:this})},loadParentItems:function(t){var e={projectScopeUp:!0};return promiseAll(["PortfolioItem","HierarchicalRequirement","Defect"].map(function(a){return Ext.create("Rally.data.wsapi.Store",{model:a,filters:Rally.data.wsapi.Filter.fromQueryString(t),fetch:["ObjectID","Milestones","Parent","PortfolioItem"],context:e,autoLoad:!0,limit:1/0}).load()}))},getConfigForChart:function(t,e,a,i,o,n){var r=collectIds(o),s={_ProjectHierarchy:this.projectId,$and:[{_ItemHierarchy:{$in:t}}],_TypeHierarchy:{$in:["Defect","HierarchicalRequirement"]},Children:null};r.length>0&&s.$and.push({_ItemHierarchy:{$in:r}}),a.length>0&&s.$and.push({_ItemHierarchy:{$in:a}});var l=["_ValidFrom","_ValidTo","ObjectID","FormattedID","PlanEstimate","ScheduleState"],c={find:s,fetch:l,hydrate:["ScheduleState"],compress:!0,sort:{_ValidFrom:1},limit:1/0,removeUnauthorizedSnapshots:!0,useHttpPost:!0};this.getSetting("debug")&&(c.listeners={load:createLogger(e,o,i,n,l)});var d=lastBusinessDay(new Date),h=this.getTargetDate(e),p=this.getSetting("maxDaysAfterTargetDate"),u=h;if(h){if(d>h){var g=addBusinessDays(h,p);u=d>g?d:g}}else u=d;return{calculatorType:"My.MilestoneBurnUpCalculator",calculatorConfig:{endDate:u,calculationConfig:{targetDate:h,iteration:this.iteration,capacityPlan:this.capacityPlan,auxDates:this.getAuxDates(e),drawIterations:this.getSetting("drawIterations"),customStartDate:this.getSetting("customStartDate"),customTrendStartDate:this.getSetting("customTrendStartDate"),maxDaysAfterTargetDate:p,displayWidth:this.getSetting("displayWidth")}},storeType:"Rally.data.lookback.SnapshotStore",storeConfig:c,exceptionHandler:loggingSnapshotStoreExceptionHandler,queryErrorMessage:"No work items found for <strong>"+this.getChartTitle(e,i,o,!0)+"</strong>.",chartConfig:{title:{text:this.getChartTitle(e,i,o,!1),useHTML:!0}}}},ensureColorsForMilestones:function(t){t&&t.forEach(function(t){t.get("DisplayColor")||t.set("DisplayColor","#888888")})},getTargetDate:function(t){var e=this,a=null;return t.forEach(function(t){var i=t.get("TargetDate");(!a||i&&i>a)&&(a=i,e.scopeColor=t.get("DisplayColor"))}),e.scopeColor||(e.scopeColor="#D42"),a},getAuxDates:function(t){var e={},a=this;return t.forEach(function(i){a.getSetting("markAuxDates")&&i.get("Notes").split(/<\/?[^>]+>/g).map(function(t){return t.trim().match(/^(\d\d\d\d-\d\d?-\d\d?)\W+(\w.*)$/)}).forEach(function(t){t&&!isNaN(Date.parse(t[1]))&&(e[t[1]]=t[2].length<=20?t[2]:t[2].substring(0,20).trim()+"...")}),t.length>1&&i.get("TargetDate")&&(e[dateToIsoString(i.get("TargetDate"))]=milestoneIcon(i)+i.get("Name"))}),e},getChartTitle:function(t,e,a,i){var o=this.getContext(),n=t.map(function(t){return formatMilestone(t,o)}).join(", ");return a.length>0&&(n+=": "+a.map(function(t){return formatPortfolioItem(t,o)}).join(", ")),e.length>0&&(console.log(e),n+=e.map(function(t){return"<span style='background-color: #C4D8E8; border-radius: 3px; margin: 0 0 0 5px; padding: 0 4px; font-size: 90%'>"+t+"</span>"}).join("")),this.getSetting("displayProjectName")&&(n+=" &mdash; "+formatProject(this.project,this.getSetting("projectTargetPage"))),i?n:"<div style='margin-top: -5px; text-align: center'>"+n+"</div>"}},dev?dev.app:null));

            Rally.launchApp('MilestoneBurnupWithProjection', {
                name:"Milestone Burnup with Projection",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .center{text-align:center}
    </style>
</head>
<body>
</body>
</html>
