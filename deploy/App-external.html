<!DOCTYPE html>
<html>
<head>
    <title>Milestone Burnup with Projection</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                function storeDataToString(data,columns){if(!data||!data[0]||!data[0].raw)return"No data to display: "+data;var actualColumns=columns||Object.keys(data[0].raw),keys=actualColumns.map(function(column){return column.split(".")});return data.reduce(function(result,row){return result.push(keys.map(function(key){var value=row.raw[key[0]];return"[object Object]"==""+value&&key[1]?value[key[1]]:value}).join("	")),result},[actualColumns.join("	")+"	"+data.length]).join("\n")}function resolvedPromise(value){return Deft.promise.Promise.when(value)}function rejectedPromise(error){var deferred=Ext.create("Deft.Deferred");return deferred.reject(error),deferred.promise}function promiseAll(array){return 0===array.length?[]:Deft.Promise.all(array)}function collectIds(objects){return objects.map(function(object){return+object.raw.ObjectID})}function getRallyRecordType(record){return record&&record.getData()._type}function getRallyIdFromRef(ref,type){return+ref.slice(type.length+2)}function milestoneIcon(milestone){return"<span class='artifact-icon icon-milestone' style='transform:rotate(20deg);color: "+milestone.get("DisplayColor")+";'></span>"}function formatMilestone(milestone,context){return milestoneIcon(milestone)+"<a target='_blank' style='color:#274b6d' href='"+getMilestoneUrl(milestone,context)+"'>"+milestone.get("Name")+"</a>"}function getMilestoneUrl(milestone,context){return"https://rally1.rallydev.com/#/"+context.getProject().ObjectID+"d/detail"+milestone.getUri()}function formatProject(project,page){return page?"<a target='_blank' style='color:#274b6d' href='https://rally1.rallydev.com/#/"+project.get("ObjectID")+"d/"+page+"'>"+project.get("Name")+"</a>":project.get("Name")}function formatPortfolioItem(portfolioItem,context){return"<a target='_blank' style='color:#274b6d' href='"+getPortfolioItemUrl(portfolioItem,context)+"'><strong style='font-size:0.95em'>"+portfolioItem.get("FormattedID")+"</strong> "+portfolioItem.get("Name")+"</a>"}function getPortfolioItemUrl(portfolioItem,context){return"https://rally1.rallydev.com/#/"+context.getProject().ObjectID+"d/detail"+portfolioItem.getUri()}function hasOwnProperties(object,minNumber){minNumber=minNumber?minNumber:1;for(var property in object)if(object.hasOwnProperty(property)&&!--minNumber)return!0;return!1}function loggingSnapshotStoreExceptionHandler(proxy,response,operation){var messages=JSON.parse(response.responseText),log=function(message){console.log(message)};console.log("Problem when obtaining snapshot data:"),messages.Errors.forEach(log),messages.Warnings.forEach(log),console.log("proxy:",proxy,"response:",response,"operation:",operation)}function formatDate(date){return Rally.util.DateTime.format(date instanceof Date?date:new Date(date),"dMy")}function dateToIsoString(date){return date.toISOString().substring(0,10)}function chainedExpression(operator,expressions){var joined=expressions.filter(function(expression){return!!expression}).join(") "+operator+" (");return"(("+joined+"))"}function workItemQuery(data,condition){var itemIDs=data.filter(function(item){return"9999-01-01T00:00:00.000Z"===item.data._ValidTo}).filter(condition).map(function(item){return"ObjectID = "+item.data.ObjectID});return itemIDs.length>0?chainedExpression("OR",itemIDs):"* no such items *"}function isUserStory(item){return 0===item.data.FormattedID.indexOf("US")}function isDefect(item){return 0===item.data.FormattedID.indexOf("DE")}function isAccepted(item){return"Accepted"===item.data.ScheduleState||"Released-to-Production"===item.data.ScheduleState}function addBusinessDays(date,businessDays){var result=new Date(date);if(businessDays){for(var oldTimezoneOffset=result.getTimezoneOffset(),days=result.getDate(),dayOfMonth=result.getDay(),step=businessDays>0?1:-1,weekDayStep=businessDays>0?1:6;0!==businessDays;)days+=step,dayOfMonth=(dayOfMonth+weekDayStep)%7,0!==dayOfMonth&&6!==dayOfMonth&&(businessDays-=step);result.setDate(days);var offsetDiff=result.getTimezoneOffset()-oldTimezoneOffset;0!==offsetDiff&&result.setTime(result.getTime()-6e4*offsetDiff)}return result}function lastBusinessDay(date){var weekDay=new Date(date).getDay();return weekDay>0&&6>weekDay?date:lastBusinessDay(addBusinessDays(date,-1))}function parseCapacityPlan(capacityPlanDefinition){if(!capacityPlanDefinition)return null;var capacityPlanString=(""+capacityPlanDefinition).trim();if(!capacityPlanString)return null;for(var parts=("1970-01-01 "+capacityPlanString).split(/\s+/),date,previousDate=new Date(-1),capacityPlan={dates:[],values:[]},dateIndex=0,capacityIndex=1;parts.length>capacityIndex;dateIndex+=2,capacityIndex+=2){if(date=new Date(parts[dateIndex]),!parts[dateIndex].match(/^\d\d\d\d-\d\d?-\d\d?$/)||isNaN(date.getTime()))throw"'"+parts[dateIndex]+"' found when a date was expected. The expected format is YYYY-MM-DD";if(previousDate>=date)throw"Invalid date: '"+dateToIsoString(date)+"'. It must be greater than '"+dateToIsoString(previousDate)+"'";previousDate=date;var capacity=parseFloat(parts[capacityIndex]);if(!parts[capacityIndex].match(/^[+\-]?(\d*(\.\d+)|\d+)$/)||isNaN(capacity))throw"'"+parts[capacityIndex]+"' found when a capacity value was expected. It must be a number";if(0>capacity)throw"'"+parts[capacityIndex]+"' found when a capacity value was expected. It must be a positive number";capacityPlan.dates.push(dateToIsoString(date)),capacityPlan.values.push(capacity)}if(capacityIndex===parts.length)throw"Unexpected value at the end: '"+parts[dateIndex]+"'. Capacity Plan definition must end with a capacity value preceeded by a date";return capacityPlan.dates.push(dateToIsoString(new Date(9999999999999))),capacityPlan}function createLogger(milestones,portfolioItems,tags,project,fetchFields){return function(store,data,success){var label="***** DEBUG INFO for MILESTONE BURNUP "+milestones.map(function(milestone){return"<> "+milestone.get("Name")}).join(", ");portfolioItems&&(label+=": "+portfolioItems.map(function(milestone){return milestone.get("FormattedID")}).join(", ")),tags.length>0&&(label+=" ["+tags.join("][")+"]"),label+=" - "+project.get("Name")+" ***** ";var log=function(title,content){console.debug(label+title+":"),console.debug(content),console.debug()};log("DATA SNAPSHOTS",storeDataToString(data,fetchFields)),log("Query for ALL STORIES",workItemQuery(data,function(item){return isUserStory(item)})),log("Query for ALL DEFECTS",workItemQuery(data,function(item){return isDefect(item)})),log("Query for NOT YET ACCEPTED STORIES",workItemQuery(data,function(item){return isUserStory(item)&&!isAccepted(item)})),log("Query for NOT YET ACCEPTED DEFECTS",workItemQuery(data,function(item){return isDefect(item)&&!isAccepted(item)}))}}function filterOutUnwantedPortfolioItems(ids,items){return items.filter(function(item){return-1!==ids.indexOf(item.get("FormattedID"))})}
                Ext.define("My.BurnUpCalculation",{calculate:function(data,config){this.calcConfig={today:config.today||new Date,maxEndDate:config.maxEndDate,iteration:config.iteration,capacityPlan:config.capacityPlan,auxDates:config.auxDates,drawIterations:config.drawIterations,targetDate:config.targetDate,customStartDate:config.customStartDate,maxDaysAfterTargetDate:config.maxDaysAfterTargetDate,hideProjectedDateOutOfRange:config.hideProjectedDateOutOfRange,customTrendStartDate:config.customTrendStartDate,displayWidth:config.displayWidth};var tooltipStructure={Scope:{position:0},"Not Started":{position:1},"In Progress":{position:2},Completed:{position:3},Accepted:{position:4}},capacityProvider={capacity:function(index){return this.projectionCalculator.capacityPlan?this.projectionCalculator.stepWeight(index):null},idealBurnUp:function(index){return this.idealSeries&&this.idealSeries[index-1]&&this.idealSeries[index]?this.idealSeries[index]-this.idealSeries[index-1]:null}};return this.capacityProvider=capacityProvider,this.chartConfig={xAxis:{plotLines:[]},yAxis:{},subtitle:{useHTML:!0},tooltip:{formatter:function(){var model={categories:[],get:function(series){return model.categories[tooltipStructure[series].position]},set:function(series,object){model.categories[tooltipStructure[series].position]=object}};this.points.forEach(function(p){model.set(p.series.name,{value:p.y,name:p.series.name,color:p.series.color})}),model.get("Scope")&&model.get("In Progress")&&model.get("Completed")&&model.get("Accepted")&&model.set("Not Started",{value:model.get("Scope").value-model.get("In Progress").value-model.get("Completed").value-model.get("Accepted").value,name:"Not Started",color:"#CFCFCF"}),model.categories.forEach(function(category){if(category.valueWholePart=Math.floor(category.value),category.valueDecimalPart=Math.floor(Math.round(10*(category.value-category.valueWholePart))),category.valueDecimalPart&&(model.isValueDecimalPart=!0),model.get("Scope")){var perMil=Math.round(1e3*(category.value/model.get("Scope").value)),percentWholePart=Math.floor(perMil/10);category.percent=percentWholePart+"."+Math.floor(Math.round(perMil-10*percentWholePart))+"%"}});var tooltip="<table style='border-spacing: 1ex 0; width: 100%'><caption style='padding-bottom: 0.4em'>"+this.x+"</caption>";model.categories.forEach(function(category){if(category.value>0){var valueHTML=category.valueWholePart+(model.isValueDecimalPart?"."+category.valueDecimalPart:"");tooltip+="<tr><td style='color:"+category.color+"'>"+category.name+":</td>"+"<td style='font-weight: bold; text-align: right'>"+valueHTML+"</td>"+(category.percent?"<td style='text-align: right'>"+category.percent+"</td>":"")+"</tr>"}}),tooltip+="</table>";var footer=[],index=this.points[0].point.x,capacity=capacityProvider.capacity(index);null!==capacity&&footer.push("Planned capacity: "+capacity);var velocity=capacityProvider.idealBurnUp(index);return null!==velocity&&footer.push("Ideal burnup: <b>"+velocity.toFixed(2)+"</b>"),footer&&(tooltip+="<div style='padding-top: 0.8em; text-align: center; font-size: 0.9em'>"+footer.join("<br/>")+"</div>"),tooltip},useHTML:!0,shared:!0}},this.adjustChartStart(data),this.stripFutureBars(data),this.addTrendLinesAndSubtitle(data),this.adjustDataAndChartConfig(data),this.chartConfig},adjustChartStart:function(data){var firstInProgressIndex=this.findDateIndex(data.categories,lastBusinessDay(this.calcConfig.today),!1,data.categories.length);data.series.forEach(function(series){if("Scope"!==series.name)for(var i=0;series.data.length>i;i++)if(series.data[i]>0&&firstInProgressIndex>i){firstInProgressIndex=i;break}});var startIndex=this.calcConfig.customStartDate?this.findDateIndex(data.categories,this.calcConfig.customStartDate,!1,0):firstInProgressIndex;data.series.forEach(function(series){series.data=series.data.slice(startIndex)}),data.categories=data.categories.slice(startIndex)},stripFutureBars:function(data){var currentIndex=this.findDateIndex(data.categories,this.calcConfig.today,!1,data.categories.length)+1;data.series.forEach(function(series){if("Scope"!==series.name)for(var i=currentIndex;series.data.length>i;i++)series.data[i]=null})},addVerticalLine:function(label,index,config){if(-1!==index){for(var plotLines=this.chartConfig.xAxis.plotLines,i=0;plotLines.length>i;i++)plotLines[i].value===index&&(label=plotLines[i].label.text+" / "+label,plotLines.splice(i,1));plotLines.push(Ext.merge({label:{text:label,y:3,x:3,useHTML:!0},value:index,width:2,color:"#000",zIndex:5},config))}},addSeriesLine:function(data,name,series,config){series&&data.series.push(Ext.merge({name:name,data:series,type:"line",marker:{enabled:!1},enableMouseTracking:!1,lineWidth:1},config))},addSubtitleText:function(text){var subtitle=this.chartConfig.subtitle;subtitle.text=subtitle.text?subtitle.text+" &nbsp;&nbsp;&nbsp; "+text:text},addTrendLinesAndSubtitle:function(data){var config=this.calcConfig,acceptedData=this.getSeriesData(data,"Accepted"),plannedData=this.getSeriesData(data,"Scope"),dates=data.categories,todayIndex=this.findDateIndex(dates,config.today),targetDateIndex=this.findDateIndex(dates,this.calcConfig.targetDate),todayAcceptedPoints=acceptedData[todayIndex],todayPlannedPoints=plannedData[todayIndex],projectionStart=this.getTrendStart(dates,acceptedData),trendSeries,completedIndex,projectionCalculator=this.createProjectionCalculator({capacityPlan:this.calcConfig.capacityPlan,projectionStart:projectionStart,firstDate:dates[0]});if(this.capacityProvider.projectionCalculator=projectionCalculator,this.calcConfig.targetDate){var idealSeries=projectionCalculator.projectionSeries(targetDateIndex,plannedData[targetDateIndex],targetDateIndex);this.capacityProvider.idealSeries=idealSeries,this.addSeriesLine(data,"Ideal",idealSeries,{dashStyle:"Dot"}),this.addSubtitleText("Target Date: "+formatDate(this.calcConfig.targetDate))}var trendControlIndex=todayIndex;if(todayAcceptedPoints===todayPlannedPoints&&todayPlannedPoints>0){for(var k=trendControlIndex-1;acceptedData[k]===todayPlannedPoints||null===acceptedData[k]&&plannedData[k]===todayPlannedPoints;)trendControlIndex--,k--;completedIndex=trendControlIndex}else{var lastIndex=dates.length-1,lastPlannedPoints=plannedData[lastIndex];if(acceptedData[lastIndex]===lastPlannedPoints&&lastPlannedPoints>0){completedIndex=lastIndex;for(var l=lastIndex-1;acceptedData[l]===lastPlannedPoints||null===acceptedData[l]&&plannedData[l]===lastPlannedPoints;)completedIndex--,l--}}var projectedDateIndex,maxIndex;if(-1!==trendControlIndex){var maxDaysAfterTargetDate=this.calcConfig.maxDaysAfterTargetDate||0;maxIndex=Math.max(todayIndex,(-1===targetDateIndex?trendControlIndex:targetDateIndex)+maxDaysAfterTargetDate);var trendFactor=projectionCalculator.projectionFactor(trendControlIndex,todayAcceptedPoints,1/0,todayPlannedPoints);1/0!==trendFactor&&(trendSeries=projectionCalculator.projectionSeries(trendControlIndex,todayAcceptedPoints,1/0,todayPlannedPoints),trendSeries&&(this.addSeriesLine(data,"Trend",trendSeries.slice(0,maxIndex+1),{dashStyle:"Dash"}),projectedDateIndex=trendSeries.length-1,this.projectedEndDate=addBusinessDays(new Date(dates[0]),projectedDateIndex),!completedIndex&&this.projectedEndDate&&(!this.calcConfig.hideProjectedDateOutOfRange||maxIndex>=projectedDateIndex)&&this.addSubtitleText("Projected Date: "+formatDate(this.projectedEndDate))));for(var j=Math.max(todayIndex,targetDateIndex,dates.length-1);maxIndex>j;j++)plannedData.push(todayPlannedPoints),dates.push(dateToIsoString(addBusinessDays(new Date(dates[dates.length-1]),1)))}var spliceIndex,deleteCount=dates.length;if(completedIndex)spliceIndex=Math.max(completedIndex,targetDateIndex)+1,dates.splice(spliceIndex,deleteCount),acceptedData.splice(spliceIndex,deleteCount),plannedData.splice(spliceIndex,deleteCount),this.getSeriesData(data,"In Progress").splice(spliceIndex,deleteCount),this.getSeriesData(data,"Completed").splice(spliceIndex,deleteCount),this.addSubtitleText("Accepted: "+formatDate(dates[completedIndex]));else{var ifEmpty=function(index,ifEmpty){return-1===index||null===index||void 0===index?ifEmpty:index};spliceIndex=Math.max(ifEmpty(todayIndex,0),ifEmpty(targetDateIndex,0),Math.min(ifEmpty(projectedDateIndex,null),ifEmpty(maxIndex,null)))+1,spliceIndex&&(dates.splice(spliceIndex,deleteCount),plannedData.splice(spliceIndex,deleteCount))}this.addPlotLines(dates,projectedDateIndex,completedIndex);var maxPlannedPoints=plannedData.reduce(function(e,max){return e>max?e:max},0),yMax=1.3*todayPlannedPoints;maxPlannedPoints>yMax&&(this.chartConfig.yAxis.max=yMax),config.drawIterations&&this.addIterationsBands(dates)},addPlotLines:function(dates,projectedEndIndex,completedIndex){var config=this.calcConfig;if(config.auxDates&&hasOwnProperties(config.auxDates,1))for(var auxDate in config.auxDates)config.auxDates.hasOwnProperty(auxDate)&&this.addVerticalLine(config.auxDates[auxDate],this.findDateIndex(dates,auxDate,!0),{width:1,label:{x:2}});this.addVerticalLine("Today",this.findDateIndex(dates,config.today,!0),{color:"#AAA",dashStyle:"ShortDash"}),this.addVerticalLine("Target Date",this.findDateIndex(dates,config.targetDate,!0)),completedIndex?this.addVerticalLine("Accepted",completedIndex,{color:"#774"}):projectedEndIndex&&this.addVerticalLine("Projected Date",projectedEndIndex,{dashStyle:"ShortDash"})},addIterationsBands:function(dates){for(var config=this.calcConfig,iterationStartDate=config.iteration.get("StartDate"),iterationEndDate=config.iteration.get("EndDate"),iterationDuration=0,date=iterationStartDate;iterationEndDate>date;)date=addBusinessDays(date,1),iterationDuration++;for(var band=!0,startDate=iterationStartDate;dateToIsoString(startDate)>dates[0];)startDate=addBusinessDays(startDate,-iterationDuration),band=!band;do startDate=addBusinessDays(startDate,iterationDuration),band=!band;while(dateToIsoString(startDate)<dates[0]);var startIndex=this.findDateIndex(dates,startDate);if(-1!==startIndex){var color="#F8F9FD";this.chartConfig.xAxis.plotBands=[];var i=startIndex-(band?iterationDuration:0);do this.chartConfig.xAxis.plotBands.push({color:color,from:Math.max(0,i),to:i+iterationDuration}),i+=2*iterationDuration;while(dates.length>i)}},getTrendStart:function(dates,acceptedData){var index;if(this.calcConfig.customTrendStartDate)index=this.findDateIndex(dates,this.calcConfig.customTrendStartDate,!1,0);else for(index=0;acceptedData.length>index&&!(acceptedData[index]>0);index++);return{index:index,value:acceptedData[index]||0}},findDateIndex:function(dates,date,floating,defaultIndex){var searchedDateString=date instanceof Date?dateToIsoString(date):date;if(dates.length>0&&searchedDateString>=dates[0])for(var i=0;dates.length>i;i++){var dateString=dates[i];if(dateString>=searchedDateString)return dateString>searchedDateString?i-(floating?.5:1):i}return defaultIndex||0===defaultIndex?defaultIndex:-1},getSeriesData:function(data,name){for(var i=0;data.series.length>i;i++){var s=data.series[i];if(s.name===name)return s.data}return[]},adjustDataAndChartConfig:function(data){data.categories=data.categories.map(function(date){return formatDate(date)});var displayWidth=Math.max(Math.min(+this.calcConfig.displayWidth||100,500),10),threshold=data.categories.length*(100/displayWidth),step,lineWidth,groupPadding,markerEnabled;threshold>360?(groupPadding=0,lineWidth=3,step=30):threshold>240?(groupPadding=.05,lineWidth=3,step=20):threshold>120?(groupPadding=.1,lineWidth=3,step=10):(groupPadding=.15,markerEnabled=!0,lineWidth=3,step=5),Ext.merge(this.chartConfig,{xAxis:{labels:{step:step}},plotOptions:{line:{marker:{enabled:markerEnabled},lineWidth:lineWidth},column:{groupPadding:groupPadding}}})},createProjectionCalculator:function(config){return config.capacityPlan?Ext.create("My.FlexProjectionCalculator",config):Ext.create("My.FixedProjectionCalculator",config)}}),Ext.define("My.FixedProjectionCalculator",{constructor:function(config){this.callParent(arguments),this.startIndex=config.projectionStart.index,this.startValue=config.projectionStart.value},projectionFactor:function(endIndex,endValue){return this.startIndex>=0&&endIndex>this.startIndex&&this.startValue!==endValue?this._projectionFactor(endIndex,endValue):(console.log("Unable to calculate trend step for values: (startIndex="+this.startIndex+", startValue="+this.startValue+", endIndex="+endIndex+", endValue="+endValue+")"),null)},projectionSeries:function(endIndex,endValue,indexLimit,valueLimit){var projectionFactor=this.projectionFactor(endIndex,endValue);if(projectionFactor&&projectionFactor>0&&0!==indexLimit){var data=[],i;for(i=0;this.startIndex>i;i++)data[i]=null;data[i]=this.startValue,i++;for(var actualIndexLimit=indexLimit||1/0;actualIndexLimit>=i&&(!valueLimit||valueLimit>data[i-1]+1e-9);i++)data[i]=data[i-1]+projectionFactor*this.stepWeight(i);return data}return null},stepWeight:function(index){return 1},_projectionFactor:function(endIndex,endValue){return(endValue-this.startValue)/(endIndex-this.startIndex)}}),Ext.define("My.FlexProjectionCalculator",{extend:"My.FixedProjectionCalculator",constructor:function(config){this.callParent(arguments),this.capacity=[],this.capacityPlan=config.capacityPlan,this.capacityPlanCursor=0,this.dateCursor=config.firstDate},stepWeight:function(index){if(this.capacity[index])return this.capacity[index];for(var i=this.capacity.length;index>=i;i++)this.dateCursor>=this.capacityPlan.dates[this.capacityPlanCursor+1]&&this.capacityPlanCursor++,this.capacity[i]=this.capacityPlan.values[this.capacityPlanCursor],this.dateCursor=dateToIsoString(addBusinessDays(this.dateCursor,1));return this.capacity[index]},_projectionFactor:function(endIndex,endValue){for(var weightSum=0,i=this.startIndex+1;endIndex>=i;i++)weightSum+=this.stepWeight(i);return(endValue-this.startValue)/weightSum}});
                window.dev=window.dev||void 0,Ext.define("MilestoneBurnupWithProjection",Ext.merge({extend:"Rally.app.App",componentCls:"app",setContextTimebox:function(timeboxScope){this._timeboxFromScope=timeboxScope&&timeboxScope.getRecord()},getContextTimebox:function(){return this._timeboxFromScope||this.setContextTimebox(this.getContext().getTimeboxScope()),this._timeboxFromScope},getSettingsFields:function(){var milestones=this.getSetting("milestones"),defaultConfig={width:400,labelWidth:210},dateFieldConfig=Ext.merge(Ext.clone(defaultConfig),{format:"Y-m-d"}),checkboxConfig={labelWidth:380},currentProjectText="-- Current Project --",contextTimebox=this.getContextTimebox(),settingsFields=[];return settingsFields.push({name:"milestones",label:"<abbr title='What do the chart bars and the Scope line mean?\n\nChart displays historical estimation (Plan Est) of stories and defects assigned to the specified milestone, aggregated by Schedule State.\nScope is the total estimate. Only leaf stories&apos; estimates count. Milestone assigned to a parent story or portfolio item is implicitly\npropagated to the child items. Items that were assigned to the milestone in the past but no longer are, are not considered in the chart at all.'>Milestone(s)</abbr>",xtype:"rallymilestonecombobox",editable:!0,multiSelect:!0,allowNoEntry:!0,emptyText:"-- Choose --",hideLabel:!1,autoSelect:!1,forceSelection:"string"!=typeof milestones||0>milestones.indexOf(",")}),settingsFields.push({html:"<h3>Additional options</h3>",xtype:"label"}),settingsFields.push({name:"project",label:"Project",xtype:"rallyprojectcombobox",allowBlank:!0,allowClear:!0,clearText:currentProjectText,emptyText:currentProjectText,listeners:{ready:function(comp){var originalValidator=comp.validator;comp.validator=function(value){return currentProjectText==value&&(value="",this.setValue(value)),!value||originalValidator.call(this,value)}}},config:defaultConfig}),settingsFields.push({name:"teamFeatures",xtype:"textfield",label:"<abbr title='One or more IDs of Portfolio Items, of which story or defect\nmust be a direct or indirect child, for example:\n\nTF12345, FEA1234, PRJ123, PGM12\n\nFor a Team Feature, you can omit the letter prefix (TF).'>Portfolio Items</abbr>:",config:defaultConfig}),settingsFields.push({name:"tags",xtype:"textfield",label:"<abbr title='Comma separated list of tags. At least one must match. Tags are inherited from parents, like milestones.\n\nInstead of assigning tags to the items in a normal way, you can use naming convention - include\nkeywords in square brackets in the item&apos;s name, for example: \"[integration] As a user, I...\".'>Tags</abbr>:",config:defaultConfig}),settingsFields.push({name:"customStartDate",xtype:"rallydatefield",label:"Ignore data until:",config:dateFieldConfig}),settingsFields.push({name:"customTrendStartDate",xtype:"rallydatefield",label:"Start projection lines from:",config:dateFieldConfig}),settingsFields.push({name:"maxDaysAfterTargetDate",xtype:"rallynumberfield",label:"Max days to show after Target Date",config:Ext.merge(Ext.clone(defaultConfig),{minValue:0,maxValue:250})}),settingsFields.push({name:"capacityPlan",xtype:"textarea",label:"Model projection lines with a specific capacity plan (provide average daily capacity values separated by the dates when they change &ndash; <abbr title='When the team capacity is 3 before September, in September 6 and 2.5 later:\n\n3 2018-09-01 6 2018-10-01 2.5'>example</abbr>)",height:70,config:defaultConfig}),settingsFields.push({name:"markAuxDates",xtype:"rallycheckboxfield",label:"Mark additional key dates on the chart (such dates must be specified in the Milestone's Notes field &ndash; <abbr title='When the Code Complete is on Dec 10 and RC Build is planned on Jan 15:\n\n2018-12-10 Code Complete&#013;2019-01-15 RC Build'>example</abbr>)",config:checkboxConfig}),settingsFields.push({name:"hideProjectedDateOutOfRange",xtype:"rallycheckboxfield",label:"Hide Projected Date in the subtitle when not visible on the chart",config:checkboxConfig}),settingsFields.push({name:"drawIterations",xtype:"rallycheckboxfield",label:"Draw Iteration boundaries on chart's background",config:checkboxConfig}),settingsFields.push({name:"showProjectName",xtype:"rallycheckboxfield",label:"Show Project name in the title",config:checkboxConfig}),settingsFields.push({name:"projectTargetPage",xtype:"textfield",label:"Project name in the title links to:",config:defaultConfig}),settingsFields.push({name:"displayWidth",xtype:"combobox",label:"Display width %, decrease it to fix chart look in a small display area",store:Ext.create("Ext.data.Store",{fields:["value"],data:[{value:100},{value:50},{value:30}]}),queryMode:"local",displayField:"value",valueField:"value",config:defaultConfig,validator:function(value){if(isNaN(value))return"Number expected";var MIN=10,MAX=300;return MIN>value||value>MAX?"Value out of allowed range ("+MIN+"-"+MAX+")":!0}}),settingsFields.push({name:"debug",xtype:"rallycheckboxfield",label:"Debug mode (prints <abbr title='Use queries that are printed to the console together with the Custom List app (paste them into the Query settings field)\nto identify which actual items (stories and defects) contribute to the chart. Note that such list is not dynamic\nand it contains only the items matching the chart criteria from the moment it was generated.'>diagnostic data</abbr> in the JavaScript console)",config:checkboxConfig}),settingsFields},config:{defaultSettings:{maxDaysAfterTargetDate:45,markAuxDates:!0,projectTargetPage:"iterationstatus",displayWidth:100,drawIterations:!0,showProjectName:!0}},getMilestoneIds:function(){if("milestone"===getRallyRecordType(this.getContextTimebox()))return[this.getContextTimebox()];var milestones=this.getSetting("milestones");return milestones?milestones.split(","):[]},getProjectId:function(){var project=this.getSetting("project");return project?getRallyIdFromRef(project,"project"):this.getContext().getProject().ObjectID},getPortfolioItemIds:function(){var portfolioItems=this.getSetting("teamFeatures");return portfolioItems?(""+portfolioItems).split(/\s*[,;\s]\s*/).filter(function(id){return""!==id}).map(function(id){return id.match(/^\d+$/)?"TF"+id:id.toUpperCase()}):[]},getTags:function(){var tags=this.getSetting("tags");return tags?(""+tags).split(/\s*[,;]\s*/).filter(function(tag){return""!==tag}):[]},setDataLoading:function(loading){this.setLoading(this.dataLoaded?!1:loading)},setDataLoaded:function(loaded){this.dataLoaded=loaded,this.setLoading(!1)},layout:"fit",launch:function(){this.getDataForChart().then({success:function(chartSetup){this.add(Ext.merge(this.createChart(),chartSetup))},failure:function(error){this.setDataLoaded();var lines=["Unable to fetch data."];error&&error.error&&error.error.errors?lines=lines.concat(error.error.errors):lines.push(error),this.add({itemId:"chart",xtype:"container",html:lines.join("<br/>"),componentCls:"center"})},scope:this})},onTimeboxScopeChange:function(timeboxScope){var timebox=timeboxScope.getRecord(),timeboxType=getRallyRecordType(timebox);if("milestone"===timeboxType){this.setContextTimebox(timeboxScope);var settings={milestones:[timebox.get("_ref")]};Rally.data.PreferenceManager.update({appID:this.getAppId(),settings:settings}),this.remove("chart"),this.setDataLoaded(!1),this.launch()}},listeners:{boxready:function(app){app.setDataLoading(!0)},ready:function(app){app.defineCalculator()}},defineCalculator:function(){function metric(label,values){return{as:label,f:"filteredSum",field:"PlanEstimate",filterField:"ScheduleState",filterValues:values,display:"column"}}Ext.define("My.MilestoneBurnUpCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",mixins:["My.BurnUpCalculation"],getMetrics:function(){return[metric("In Progress",["In-Progress"]),metric("Completed",["Completed"]),metric("Accepted",["Accepted","Released-to-Production"]),{as:"Scope",f:"sum",field:"PlanEstimate",display:"line"}]},runCalculation:function(snapshots,snapshotsToSubtract){var data=this.callParent(arguments);return this.chartConfig=this.calculate(data,this.calculationConfig),data}})},createChart:function(){var app=this;return Ext.create("Rally.ui.chart.Chart",{itemId:"chart",chartColors:["#B4F4D9","#9FDDA7","#6DBD44",app.scopeColor,"#000","#000"],chartConfig:{title:{text:"Milestone"},chart:{zoomType:"xy"},xAxis:{title:{text:"Date"},labels:{maxStaggerLines:1,step:5}},yAxis:{title:{text:"Points"},minRange:10,min:0},plotOptions:{line:{marker:{enabled:!1},lineWidth:4},column:{pointPadding:0,stacking:!0},area:{stacking:!0,marker:{enabled:!1}}}},listeners:{snapshotsAggregated:function(chart){Ext.merge(chart.chartConfig,chart.calculator.chartConfig)},storesLoaded:function(){app.setLoading(!1)}}})},getDataForChart:function(){var portfolioItemIds=this.getPortfolioItemIds(),tags=this.getTags();return promiseAll([this.getProjectId()?Rally.data.ModelFactory.getModel({type:"Project"}).then({success:function(model){return model.load(this.getProjectId())},scope:this}):this.getProjectId(),Ext.create("Rally.data.wsapi.Store",{model:"Iteration",fetch:["StartDate","EndDate"],filters:Rally.data.wsapi.Filter.fromQueryString("((StartDate <= today) AND (EndDate >= today))")}).load(),0===this.getMilestoneIds().length?[]:Rally.data.ModelFactory.getModel({type:"Milestone"}).then({success:function(model){return promiseAll(this.getMilestoneIds().map(function(id){return model.load(id)}))},scope:this}),0===portfolioItemIds.length?[]:Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem",filters:Rally.data.wsapi.Filter.fromQueryString(chainedExpression("OR",portfolioItemIds.map(function(id){return"FormattedID = "+id}))),scope:this,context:{projectScopeUp:!0}}).load()]).then({success:function(contextItems){try{this.capacityPlan=parseCapacityPlan(this.getSetting("capacityPlan"))}catch(error){return rejectedPromise("The following problem found in the Capacity Plan definition: <p>"+error+"</p>. "+"Please correct the app settings:<pre>"+this.getSetting("capacityPlan")+"</pre>")}this.project=contextItems[0],this.iteration=contextItems[1][0];var milestones=contextItems[2];if(this.ensureColorsForMilestones(milestones),0===milestones.length)return rejectedPromise("No milestone specified. Set milestone filter in your page settings or choose milestone in the app settings.");if(this.portfolioItems=filterOutUnwantedPortfolioItems(this.getPortfolioItemIds(),contextItems[3]),0===this.portfolioItems.length&&portfolioItemIds.length>0)return rejectedPromise("None of the Portfolio Items specified in the app settings: <p>"+portfolioItemIds.join(", ")+"</p>, "+"exist in this project. Please correct the app settings or change the project.");var loadParentsByMilestone=this.loadParentItems(chainedExpression("OR",milestones.map(function(milestone){return"Milestones.ObjectID contains "+milestone.getId()}))),loadParentsByTags=0===tags.length?[]:this.loadParentItems(chainedExpression("OR",tags.map(function(tag){return'(Tags.Name = "'+tag+'") OR (Name contains "['+tag+']")'})));return promiseAll([loadParentsByMilestone,loadParentsByTags]).then({success:function(results){var parentIdsByMilestone=collectIds([].concat.apply([],results[0])),parentIdsByTag=collectIds([].concat.apply([],results[1]));return this.getConfigForChart(parentIdsByMilestone,milestones,parentIdsByTag,tags,this.portfolioItems,this.project)},scope:this})},scope:this})},loadParentItems:function(query){var context={projectScopeUp:!0};return promiseAll(["PortfolioItem","HierarchicalRequirement","Defect"].map(function(artifactType){return Ext.create("Rally.data.wsapi.Store",{model:artifactType,filters:Rally.data.wsapi.Filter.fromQueryString(query),fetch:["ObjectID","Milestones","Parent","PortfolioItem"],context:context,autoLoad:!0,limit:1/0}).load()}))},getConfigForChart:function(parentIdsByMilestone,milestones,parentIdsByTag,tags,portfolioItems,project){var portfolioItemIds=collectIds(portfolioItems),query={_ProjectHierarchy:this.projectId,$and:[{_ItemHierarchy:{$in:parentIdsByMilestone}}],_TypeHierarchy:{$in:["Defect","HierarchicalRequirement"]},Children:null};portfolioItemIds.length>0&&query.$and.push({_ItemHierarchy:{$in:portfolioItemIds}}),parentIdsByTag.length>0&&query.$and.push({_ItemHierarchy:{$in:parentIdsByTag}});var fetchFields=["_ValidFrom","_ValidTo","ObjectID","FormattedID","PlanEstimate","ScheduleState"],debug=this.getSetting("debug"),storeConfig={find:query,fetch:fetchFields,hydrate:["ScheduleState"],compress:!0,sort:{_ValidFrom:1},limit:1/0,removeUnauthorizedSnapshots:!0,useHttpPost:!0};debug&&(storeConfig.listeners={load:createLogger(milestones,portfolioItems,tags,project,fetchFields)});var lastWorkingDay=lastBusinessDay(new Date),targetDate=this.getTargetDate(milestones),maxDaysAfterTargetDate=this.getSetting("maxDaysAfterTargetDate"),endDate=targetDate;if(targetDate){if(lastWorkingDay>targetDate){var maxEndDate=addBusinessDays(targetDate,maxDaysAfterTargetDate);endDate=lastWorkingDay>maxEndDate?lastWorkingDay:maxEndDate}}else endDate=lastWorkingDay;return{calculatorType:"My.MilestoneBurnUpCalculator",calculatorConfig:{endDate:endDate,calculationConfig:{targetDate:targetDate,iteration:this.iteration,capacityPlan:this.capacityPlan,auxDates:this.getAuxDates(milestones),drawIterations:this.getSetting("drawIterations"),customStartDate:this.getSetting("customStartDate"),customTrendStartDate:this.getSetting("customTrendStartDate"),maxDaysAfterTargetDate:maxDaysAfterTargetDate,hideProjectedDateOutOfRange:this.getSetting("hideProjectedDateOutOfRange"),displayWidth:this.getSetting("displayWidth")}},storeType:"Rally.data.lookback.SnapshotStore",storeConfig:storeConfig,exceptionHandler:loggingSnapshotStoreExceptionHandler,queryErrorMessage:"No work items found for <p>"+this.getChartTitle(milestones,tags,portfolioItems,!0)+"</p>.",chartConfig:{title:{text:this.getChartTitle(milestones,tags,portfolioItems,!1),useHTML:!0}}}},ensureColorsForMilestones:function(milestones){milestones&&milestones.forEach(function(milestone){milestone.get("DisplayColor")||milestone.set("DisplayColor","#888888")})},getTargetDate:function(milestones){var app=this,latestMilestoneDate=null;return milestones.forEach(function(milestone){var date=milestone.get("TargetDate");(!latestMilestoneDate||date&&date>latestMilestoneDate)&&(latestMilestoneDate=date,app.scopeColor=milestone.get("DisplayColor"))}),app.scopeColor||(app.scopeColor="#D42"),latestMilestoneDate},getAuxDates:function(milestones){var result={},app=this;return milestones.forEach(function(milestone){app.getSetting("markAuxDates")&&milestone.get("Notes").split(/<\/?[^>]+>/g).map(function(html){return html.trim().match(/^(\d\d\d\d-\d\d?-\d\d?)\W+(\w.*)$/)}).forEach(function(matches){matches&&!isNaN(Date.parse(matches[1]))&&(result[matches[1]]=20>=matches[2].length?matches[2]:matches[2].substring(0,20).trim()+"...")}),milestones.length>1&&milestone.get("TargetDate")&&(result[dateToIsoString(milestone.get("TargetDate"))]=milestoneIcon(milestone)+milestone.get("Name"))}),result},getChartTitle:function(milestones,tags,portfolioItems,inlineDisplay){var context=this.getContext(),title=milestones.map(function(milestone){return formatMilestone(milestone,context)}).join(", ");return portfolioItems.length>0&&(title+=": "+portfolioItems.map(function(portfolioItem){return formatPortfolioItem(portfolioItem,context)}).join(", ")),tags.length>0&&(console.log(tags),title+=tags.map(function(tag){return"<span style='background-color: #C4D8E8; border-radius: 3px; margin: 0 0 0 5px; padding: 0 4px; font-size: 90%'>"+tag+"</span>"}).join("")),this.getSetting("showProjectName")&&(title+=" &mdash; "+formatProject(this.project,this.getSetting("projectTargetPage"))),inlineDisplay?title:"<div style='margin-top: -5px; text-align: center'>"+title+"</div>"}},dev?dev.app:null));

            Rally.launchApp('MilestoneBurnupWithProjection', {
                name:"Milestone Burnup with Projection",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .center{text-align:center}
    </style>
</head>
<body>
</body>
</html>
